<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="sql">

<!-- 회원가입 -->
<insert id="signup">
	insert into member (id, name, password, addr, agentF, agentA)
		values (#{id}, #{name}, #{password}, #{addr}, #{agentF}, #{agentA})
</insert>
<!-- 로그인 -->
<select id="login" resultType="com.ojt.domain.MemberVO">
	select *
	from member
	where (id=#{id} and password=#{password}) or (id=#{id} and temporary=#{password})
</select>
<!-- 로그인 시 현재 날짜, 실패=0 으로 업데이트 -->
<update id="loginDate">
	update member
	set (finalInDtm, failInCnt)=(CURRENT_DATE, 0)
	where (id=#{id} and password=#{password}) or (id=#{id} and temporary=#{password})
</update>
<!-- 로그인 실패 처리 -->
<update id="loginFail">
	update member
	set failInCnt=failInCnt+1
	where id=#{id}
</update>
<!-- 임시 비밀번호 발급 -->
<update id="tmpPwd">
	update member
	set temporary=#{password}
	where id=#{id}
</update>
<!-- 회원가입 시 recVal 재설정 -->
<update id="recInit">
	update ms_agentitem 
	set recVal=recVal+1
</update>

<!-- 위치 -->
<select id="locationList" resultType="com.ojt.domain.LocVO"><!-- 이렇게 해도 리스트로 넘겨주도록 MyBatis 설계 -->
	select *
	from ms_agent
	where addr_zip like '서울%'
</select>
<!-- 가장 가까운 위치 -->
<select id="location" parameterType="com.ojt.domain.LatLngVO" resultType="com.ojt.domain.LocVO">
	select cd_agent,nm_agentform, addr_zip, addr_detail, 
				earth_distance(ll_to_earth(#{lat}, #{lng}), ll_to_earth(lat, lng)
				) as distance
	from ms_agent
	where addr_zip like '${location}%' and gbn_agent=#{gbn}
	order by distance ASC
	limit 1;
</select>

<!-- 대리점 조회 -->
<select id="getAgent" parameterType="String" resultType="com.ojt.domain.LocVO">
	select cd_agent, nm_agentform
	from ms_agent
	where cd_agent=#{agentId}
	limit 1;
</select>

<!-- 대리점 별 아이템, 가격 조회 -->
<select id="itemList" parameterType="String" resultType="com.ojt.domain.ItemVO" >
	select cd_item, nm_item, amt_amount, src
	from ms_agentitem
	where cd_agent=#{agent}
</select>

<!-- 아이템 별 정보 조회 -->
<select id="itemDetail" parameterType="String" resultType="com.ojt.domain.ItemVO">
	select cd_item, nm_item, amt_amount, remark
	from ms_agentitem
	where cd_item=#{item}
	limit 1;
</select>

<!-- 아이템 이미지 크롤링 -->
<update id="itemCrawl">
	update ms_agentitem 
	set src=#{src}
	where nm_item=#{name}
</update>


<!-- 주문정보 -->
<insert id="sale" parameterType="com.ojt.domain.SaleVO">
	insert into sl_sale (no_saleslip, amt_amount, cd_agent, cd_customer, dt_sale, gbn_slip)
	values (#{noSaleslip}, #{amount}, #{agent}, #{memberid}, CURRENT_DATE, 'NN');
</insert>

<!-- 주문아이템 -->
<insert id="saleItem" parameterType="com.ojt.domain.SaleItemVO">
	insert into sl_saleitem 
		(no_saleslip, amt_amount, amt_price, cd_agent, cd_item, dt_sale, qty_delivtot, seq, cd_customer)
	values 
	(#{noSaleslip}, #{amount},#{price},#{agent}, #{item},CURRENT_DATE, #{qty}, #{seq}, #{memberid});
</insert>

<!-- 주문 시 recVal update -->
<update id="recAdd">
	update ms_agentitem 
	set recVal=(select recVal 
				from ms_agentitem 
				where cd_item=#{item} and cd_agent=#{agent})+1 
	where cd_item=#{item} and cd_agent=#{agent}
</update>

<!-- 장바구니 -->
<insert id="basket" parameterType="com.ojt.domain.BasketVO">
	insert into basket
		(memberid, nm_item, amt_amount, amt_price, cd_agent, cd_item, qty_delivtot)
	values 
	(#{memberid}, #{name}, #{amount},#{price},#{agent}, #{item}, #{qty});
</insert>

<!-- 장바구니 아이템 조회 -->
<select id="basketList" resultType="com.ojt.domain.BasketVO">
	select amt_price as price, nm_item as name, cd_item as item, qty_delivtot as qty, idx
	from basket
	where memberid=#{memberid}
</select>
<!-- 장바구니 아이템 삭제 -->
<delete id="deleteBasket">
	delete from basket
	where idx=#{idx}
</delete>
</mapper> 